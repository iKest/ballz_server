# Server

Back-end для клиента игры

### Описание полей файлов конфигурации

> Файлы конфигураций должны быть скопированны в папку `config`
> Файлы конфигураций могут
> Изначально в этой папке находятся файлы с примерами `default_example.json5` и `production_example.json5`

-   **db:**
    -   database `[string]` _- Имя базы данных_
    -   username `[string]` _- Имя пользователя, которое используется для аутентификации в базе данных_
    -   password `[string]` _- Пароль пользователя, которое используется для аутентификации в базе данных_
    -   **params:**
        -   dialect `[string]` _- Диалект, использующийся в базе данных_
        -   host `[string]` _- Арес хоста по которому происходит обращение к базе данных_
        -   port `[integer]` `[optional]` _- Порт по которому происходит обращение к базе данных_
        -   operatorsAliases `[array/boolean]` _- определение операторов символов, которые можно использовать для создания сложных сравнений._
        -   **pool:**
            -   max `[integer]` _- Максимальное количество соединений в connection pool_
            -   min `[integer]` _- Минимальное количество соединений в connection pool_
            -   acquire `[integer]` _- Максимальное время (в миллисекундах), в течение которого connection pool будет пытаться установить соединение, прежде чем выдать ошибку_
            -   idle `[integer]` _- Максимальное время в миллисекундах, в течение которого соединение может простаивать до освобождения_
            -   **define:**
                -   underscored `[boolean]` _- Метод, опеределяющий генерацию имен полей таблицы_

-   **app:**
    -   protocol `[string]` _- Протокол по которому осуществляется общение с сервером (http или https)_
    -   https `[boolean]` _- Флаг определяющий какой тип сервера будет запущен, используется при разработке, оставить значение false_
    -   port `[integer]` _- Номер порта, по которому будет доступен сервер_
	
        > данное занчение используется, если не определён `process.env.PORT`

    -   logger `[boolean]` _- Включить вывод расширенных сообщений об ошибках, используется в разработке_
    -   clientUrl `[string]` _- Адрес клиента игры_
    -   loggers `[object/array of objects]` _- Логгеры использемы сервером_

    > В настоящее время поддерживаются:
    >
    > 1. Вывод в консоль
    > 2. Сервис Loggly - нужен зарегистрированный аккаунт на сервисе

    -   staticFolder `[string]` _- Относительный путь к папке со статическим файлами сервера_
    -   staticURL `[string]` _- Относительный url по которому доступны статические файлы сервера_
-   **routes:**
    -   **client:**
        -   api `[string]` _- Относительный url по которому доступен API приложения_
    -   **ok:**
        -   payment `[string]` _- Относительный url к которому доступен payment.callback вКонтакте_
    -   **vk:**
        -   payment `[string]` _- Относительный url к которому доступен payment.callback Одноклассники_
    -   **fk:**
        -   payment `[string]` _- Относительный url к которому доступен payment.callback fakeSDK для СА клиента_
-   **socials:**
    -   **vk:**
        -   secret `[string]` _- Секретный ключ приложения в вКонтакте_
        -   service `[string]` _- Сервисный ключ приложения в вКонтакте_
        -   id `[integer]` _- Индификатор приложения в вКонтакте_
    -   **ok:**
        -   secret `[string]` _- Секретный ключ приложения в Одноклассники_
        -   service `[string]` _- Сервисный ключ приложения в Одноклассники_
        -   id `[integer]` _- Индификатор приложения в Одноклассники_
-   **new_user:**
    -   amo `[array]` _- Массив с ключами типов шаров, которые будут переданы при создании пользователя_
	
        > На данный момент доступны следующие типы шаров:
        > `ice`,`ice_s`,`fire`,`fire_s`,`shark`,`shark_s`,`air`,`air_s`,`earth`,`earth_s`
        > Актуальные типы шаров можно посмотеть в файле `data.json`,
        > который находится в папке клиента `assets/jsons/`, параметр `balls.keys`
        > Тег `_s` означает обычный размер шара, без тега - увеличинный

    -   cash `[integer]` _- Колличество внутренней валюты приложения, которое будет переданно при создании нового пользователя_
	
        > Используется при покупках с помощью `FakeSDK` в SA версии клиента
        > В дальнейшем возможна реализация покупки внутренней валюты с помощью `Яндекс.Кассы`

    -   **shop**
        -   images `[string]` _- Путь к папке с изображениями товаров_

### Установка

> Сервер требует для установки и работы [Node.js](https://nodejs.org/) v8+ с установленным [npm](https://www.npmjs.com/)

Создать и заполнить файлы конфигураций, находящиеся в папке `config`

-   Скопировать (или, усли установлен git склонировать) файлы из репозитория в рабочую папку сервера
-   Создать или скопировать файлы конфигураций, в папку `config`
-   Установить зависимости:

    ```sh
    $ cd <путь к файлам сервера>
    $ npm install --prod
    ```

-   запустить скрипт миграции таблиц базы данных:

    ```sh
    $ node servicedb -D -U
    ```
	
-   запустить сервер методом, определённым хостингом, в общем случае:

    ```sh
    $ node server
    ```

## Ключи скрипта синхронизации БД servicedb

-   **-С или --create-db** _- Создать новуб БД (требуется логин и пароль root пользователя сервера БД)_
-   **-D или --drop-tables** _- Удалить перед синхронизацией все существующие таблицы из БД_
-   **-F или --force** _- Удалять таблицу перед синхронизацией_
-   **-U или --update** _-Заполнить/обновить таблицу данными из файла миграций после синхронизации_
-   **--help** _- Вызов справки_
-   **-V, --version** _- Версия скрипта_
